<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Poppins', sans-serif; padding: 20px; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 12px; }
        .bg-reprovado { background-color: #f8d7da; color: #842029; padding: 5px 10px; border-radius: 15px; font-weight: 600; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="card p-4">
            <h4 class="text-danger fw-bold mb-4">Prontuários Devolvidos para Correção</h4>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Paciente (ID)</th>
                            <th>Motivo da Devolução (Supervisor)</th>
                            <th>Status</th>
                            <th class="text-end">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-correcoes">
                        <tr><td colspan="5" class="text-center p-4">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold">Corrigir Prontuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-edicao">
                        <input type="hidden" id="editIdTemp"> <input type="hidden" id="editIdPaciente">
                        <input type="hidden" id="editIdProced">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Texto do Prontuário / Evolução</label>
                            <textarea class="form-control" id="editTexto" rows="6" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Link Externo</label>
                            <input type="text" class="form-control" id="editLink">
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editAutoPacVisu">
                            <label class="form-check-label">Permitir Paciente Visualizar</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="salvarCorrecao()">Salvar e Reenviar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const idProfissional = window.parent.localStorage.getItem('idProfissional') || 1; 
        const idEspec = 6; 
        let modalBootstrap;

        document.addEventListener('DOMContentLoaded', () => {
            modalBootstrap = new bootstrap.Modal(document.getElementById('modalEditar'));
            carregarCorrecoes();
        });

        async function carregarCorrecoes() {
            const tbody = document.getElementById('tabela-correcoes');
            try {
                const res = await fetch(`http://localhost:8080/api/homologacao/correcoes/${idProfissional}`);
                if(!res.ok) throw new Error("Erro");
                const lista = await res.json();

                tbody.innerHTML = '';
                if(lista.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Nenhum item pendente de correção.</td></tr>';
                    return;
                }

                lista.forEach(item => {
                    // Armazena o objeto inteiro no botão para facilitar a edição
                    const dadosJson = JSON.stringify(item).replace(/"/g, '&quot;');
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${item.id}</td>
                        <td>${item.idPaciente}</td>
                        <td class="text-danger fw-bold">${item.observacaoSupervisor || 'Sem motivo'}</td>
                        <td><span class="bg-reprovado">CORREÇÃO</span></td>
                        <td class="text-end">
                            <button class="btn btn-warning btn-sm" onclick="abrirEdicao(${dadosJson})">Corrigir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro de conexão.</td></tr>';
            }
        }

        function abrirEdicao(item) {
            // Preenche o modal com os dados antigos
            document.getElementById('editIdTemp').value = item.id;
            document.getElementById('editIdPaciente').value = item.idPaciente;
            document.getElementById('editIdProced').value = item.idProced;
            document.getElementById('editTexto').value = item.texto;
            document.getElementById('editLink').value = item.linkProcedimento;
            document.getElementById('editAutoPacVisu').checked = item.autoPacVisu;
            
            modalBootstrap.show();
        }

        async function salvarCorrecao() {
            const dados = {
                id: document.getElementById('editIdTemp').value, // IMPORTANTE: Enviando o ID atualiza o existente!
                idPaciente: document.getElementById('editIdPaciente').value,
                aluno: { idprofissio: idProfissional },
                idEspec: idEspec,
                idProced: document.getElementById('editIdProced').value,
                texto: document.getElementById('editTexto').value,
                linkProcedimento: document.getElementById('editLink').value,
                autoPacVisu: document.getElementById('editAutoPacVisu').checked,
                status: "PENDENTE" // Força voltar para pendente
            };

            try {
                const res = await fetch('http://localhost:8080/api/homologacao/salvar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dados)
                });

                if (res.ok) {
                    alert("Correção enviada com sucesso!");
                    modalBootstrap.hide();
                    carregarCorrecoes(); // Atualiza a lista (o item deve sumir)
                } else {
                    alert("Erro ao salvar.");
                }
            } catch(e) { alert("Erro de conexão."); }
        }
    </script>
</body>
</html>