<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Poppins', sans-serif; padding: 20px; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 12px; }
        .form-label { font-weight: 600; color: #555; }
        
        /* Estilo para dar destaque ao input de busca */
        .search-input {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
            background-color: #fffde7; /* Amarelo bem clarinho para indicar busca */
        }
        .search-select {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="card p-4">
            <h4 class="mb-4 text-success fw-bold">Nova Prescrição / Prontuário (Fisioterapia)</h4>
            
            <form id="form-prescricao">
                <div class="row g-3">
                    
                    <div class="col-md-6">
                        <label class="form-label">Paciente (ID / RG)</label>
                        <select class="form-select" id="selectPaciente" required>
                            <option value="" selected disabled>Carregando pacientes...</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Procedimento (Busca Rápida)</label>
                        
                        <input type="text" class="form-control search-input" id="inputBuscaProced" 
                               placeholder="Digite nome, código ou ID para filtrar..." autocomplete="off">
                        
                        <select class="form-select search-select" id="selectProced" size="5" required>
                            <option value="" selected disabled>Aguardando busca...</option>
                        </select>
                        <small class="text-muted" style="font-size: 0.8rem;">* Clique no procedimento desejado na lista acima.</small>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Descrição do Prontuário / Evolução</label>
                        <textarea class="form-control" id="textoProntuario" rows="6" placeholder="Descreva a evolução do paciente..." required></textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Link Externo (Opcional)</label>
                        <input type="text" class="form-control" id="linkProced" placeholder="http://...">
                    </div>

                    <div class="col-md-6 d-flex align-items-end">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="autoPacVisu">
                            <label class="form-check-label" for="autoPacVisu">
                                Permitir que o Paciente visualize este registro?
                            </label>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-light">Limpar</button>
                    <button type="submit" class="btn btn-success px-4">SALVAR E ENVIAR</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variável Global para guardar a lista completa na memória
        let CACHE_PROCEDIMENTOS = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Tenta pegar o ID. O "|| 1" é só para teste, o login deve preencher isso.
            const idProfissionalStorage = window.parent.localStorage.getItem('idProfissional') || 1; 
            const idEspec = 6; 

            // 1. CARREGAR DADOS
            await carregarDropdownSimples('http://localhost:8080/api/dados/pacientes', 'selectPaciente', 'id', 'rg', 'Paciente');
            await inicializarProcedimentos();

            // 2. FILTRO
            document.getElementById('inputBuscaProced').addEventListener('input', (e) => {
                filtrarProcedimentos(e.target.value);
            });

            // 3. SALVAR (AQUI ESTAVA O PROBLEMA)
            document.getElementById('form-prescricao').addEventListener('submit', async (e) => {
                e.preventDefault();

                const idProcedSelecionado = document.getElementById('selectProced').value;
                if (!idProcedSelecionado) {
                    alert("Por favor, selecione um procedimento.");
                    return;
                }

                // --- JSON CORRIGIDO (PLANO) ---
                const dados = {
                    idPaciente: document.getElementById('selectPaciente').value,
                    
                    // Manda direto o ID (Integer), sem a estrutura 'aluno: {}'
                    idProfissional: parseInt(idProfissionalStorage), 
                    
                    idEspec: idEspec,
                    idProced: idProcedSelecionado,
                    texto: document.getElementById('textoProntuario').value,
                    linkProcedimento: document.getElementById('linkProced').value,
                    autoPacVisu: document.getElementById('autoPacVisu').checked
                };

                console.log("Enviando:", dados);

                try {
                    const response = await fetch('http://localhost:8080/api/homologacao/salvar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });

                    if (response.ok) {
                        alert("Prontuário salvo com sucesso!");
                        document.getElementById('form-prescricao').reset();
                        document.getElementById('inputBuscaProced').value = "";
                        filtrarProcedimentos(""); 
                    } else {
                        const erro = await response.text();
                        alert("Erro ao salvar: " + erro);
                    }
                } catch (error) {
                    console.error(error);
                    alert("Erro de conexão.");
                }
            });
        });

        // --- FUNÇÕES DE PROCEDIMENTO (FILTRO INTELIGENTE) ---

        async function inicializarProcedimentos() {
            const select = document.getElementById('selectProced');
            try {
                const res = await fetch('http://localhost:8080/api/dados/procedimentos');
                if(res.ok) {
                    CACHE_PROCEDIMENTOS = await res.json();
                    // Renderiza todos inicialmente
                    filtrarProcedimentos("");
                } else {
                    select.innerHTML = '<option disabled>Erro ao carregar lista</option>';
                }
            } catch(e) {
                console.error(e);
                select.innerHTML = '<option disabled>Erro de conexão</option>';
            }
        }

        function filtrarProcedimentos(termo) {
            const select = document.getElementById('selectProced');
            const termoLimpo = termo.toLowerCase().trim();
            select.innerHTML = ''; // Limpa as opções atuais

            // Filtra a lista da memória
            const filtrados = CACHE_PROCEDIMENTOS.filter(proc => {
                // Permite buscar por ID, Código (se existir) ou Descrição
                const id = String(proc.id);
                const desc = proc.descricao ? proc.descricao.toLowerCase() : "";
                const cod = proc.codigo ? proc.codigo.toLowerCase() : "";

                return id.includes(termoLimpo) || desc.includes(termoLimpo) || cod.includes(termoLimpo);
            });

            // Monta o HTML
            if (filtrados.length > 0) {
                filtrados.forEach(proc => {
                    const option = document.createElement('option');
                    option.value = proc.id;
                    // Exibe de forma organizada: [CÓDIGO] DESCRIÇÃO
                    const codigoExibicao = proc.codigo ? `[${proc.codigo}] ` : `[ID:${proc.id}] `;
                    option.textContent = codigoExibicao + proc.descricao;
                    select.appendChild(option);
                });
                
                // Se só tiver 1 resultado, seleciona automaticamente para agilizar
                if (filtrados.length === 1) {
                    select.selectedIndex = 0;
                }
            } else {
                select.innerHTML = '<option disabled>Nenhum procedimento encontrado.</option>';
            }
        }

        // --- FUNÇÃO PARA PACIENTES (Simples) ---
        async function carregarDropdownSimples(url, elementId, keyId, keyName, labelTipo) {
            const select = document.getElementById(elementId);
            try {
                const res = await fetch(url);
                if(res.ok) {
                    const lista = await res.json();
                    select.innerHTML = `<option value="" selected disabled>Selecione um ${labelTipo}...</option>`;
                    lista.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[keyId];
                        // Formatação especial para paciente
                        let texto = item[keyName];
                        if (keyName === 'rg') texto = `ID: ${item[keyId]} - RG: ${item[keyName] || 'S/ Doc'}`;
                        option.textContent = texto;
                        select.appendChild(option);
                    });
                }
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>