<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Poppins', sans-serif; padding: 20px; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 12px; }
        .badge-cargo { padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.8rem; }
        .bg-master { background-color: #0d6efd; color: white; }
        .bg-supervisor { background-color: #198754; color: white; }
        .bg-profissional { background-color: #6c757d; color: white; }
        .bg-admin { background-color: #212529; color: #ffc107; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-success fw-bold m-0">Gestão de Equipe / Acessos</h4>
                <button class="btn btn-outline-primary btn-sm" onclick="carregarEquipe()">Atualizar Lista</button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nome</th>
                            <th>Login</th>
                            <th>CPF (Doc)</th>
                            <th>Cargo Atual</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-equipe">
                        <tr><td colspan="5" class="text-center p-4">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCargo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alterar Cargo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Selecione o novo nível de acesso para <strong id="nome-edit"></strong>:</p>
                    <input type="hidden" id="id-profi-edit">
                    <select class="form-select" id="novo-tipo-select">
                        <option value="4">Master / Coordenador</option>
                        <option value="3">Supervisor</option>
                        <option value="2">Profissional / Estagiário</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovoCargo()">Salvar Alteração</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tipoProfiLogado = window.parent.localStorage.getItem('tipoProfi');
        const sistemaLogado = window.parent.localStorage.getItem('userSystem');
        const mapaSistemas = { 'FISIOTERAPIA': 6, 'BIOMEDICINA': 9, 'ODONTOLOGIA': 4, 'NUTRICAO': 5, 'PSICOLOGIA': 3 };
        const idEspecLogado = mapaSistemas[sistemaLogado] || 0;
        
        let modalBootstrap;

        document.addEventListener('DOMContentLoaded', () => {
            modalBootstrap = new bootstrap.Modal(document.getElementById('modalCargo'));
            carregarEquipe();
        });

        async function carregarEquipe() {
            const tbody = document.getElementById('tabela-equipe');
            try {
                const url = `http://localhost:8080/api/gestao/listar?tipoProfiLogado=${tipoProfiLogado}&idEspecLogado=${idEspecLogado}`;
                const res = await fetch(url);
                const lista = await res.json();

                tbody.innerHTML = '';
                if(lista.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum usuário encontrado.</td></tr>';
                    return;
                }

                lista.forEach(u => {
                    let badgeClass = 'bg-profissional';
                    let nomeCargo = 'Estagiário';
                    
                    if(u.tipoProfi === '4') { badgeClass = 'bg-master'; nomeCargo = 'Master'; }
                    if(u.tipoProfi === '3') { badgeClass = 'bg-supervisor'; nomeCargo = 'Supervisor'; }
                    if(u.tipoProfi === '1') { badgeClass = 'bg-admin'; nomeCargo = 'Admin Geral'; }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.nome}</td>
                        <td>${u.login}</td>
                        <td>${u.cpf}</td>
                        <td><span class="badge badge-cargo ${badgeClass}">${nomeCargo}</span></td>
                        <td class="text-end">
                            ${u.tipoProfi !== '1' ? `
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="abrirModal(${u.idProfissional}, '${u.nome}')">Editar Cargo</button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="excluirUsuario(${u.idUsuario})">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch(e) { console.error(e); }
        }

        function abrirModal(idProfi, nome) {
            document.getElementById('id-profi-edit').value = idProfi;
            document.getElementById('nome-edit').textContent = nome;
            
            // Se for Admin logado, mostra opção de Admin no select (opcional)
            // Aqui mantive simples para os módulos (2, 3, 4)
            modalBootstrap.show();
        }

        async function salvarNovoCargo() {
            const idProfi = document.getElementById('id-profi-edit').value;
            const novoTipo = document.getElementById('novo-tipo-select').value;

            try {
                const res = await fetch(`http://localhost:8080/api/gestao/alterar-cargo/${idProfi}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ novoTipo: novoTipo })
                });

                if(res.ok) {
                    alert("Cargo atualizado!");
                    modalBootstrap.hide();
                    carregarEquipe();
                } else {
                    alert("Erro ao atualizar.");
                }
            } catch(e) { alert("Erro de conexão."); }
        }

        async function excluirUsuario(idUser) {
            if(!confirm("Tem certeza que deseja excluir este usuário? Essa ação removerá o acesso dele.")) return;

            try {
                const res = await fetch(`http://localhost:8080/api/gestao/excluir/${idUser}`, {
                    method: 'DELETE'
                });

                if(res.ok) {
                    alert("Usuário excluído.");
                    carregarEquipe();
                } else {
                    alert(await res.text()); // Mostra msg se tiver prontuários vinculados
                }
            } catch(e) { alert("Erro de conexão."); }
        }
    </script>
</body>
</html>